#!/usr/bin/env bash
#
# hexis — scaffolder for the Hexis meta-cognitive framework
#
# Usage:
#   hexis init              Create Hexis directory structure in current project
#   hexis add <module>      Add a module (skill, hook, or template)
#   hexis list              List available modules
#   hexis help              Show this help
#
# Hexis is the disposition layer between raw AI intelligence and effective action.
# https://github.com/hexis-framework/hexis

set -euo pipefail

# --- Configuration ---

# Find the Hexis install directory (where templates and examples live)
HEXIS_HOME=""
if [ -n "${HEXIS_HOME_OVERRIDE:-}" ]; then
  HEXIS_HOME="$HEXIS_HOME_OVERRIDE"
elif [ -d "$(dirname "$0")/templates" ]; then
  # Running from a local clone
  HEXIS_HOME="$(cd "$(dirname "$0")" && pwd)"
elif [ -d "$HOME/.hexis/repo" ]; then
  # Installed via git clone to ~/.hexis/repo
  HEXIS_HOME="$HOME/.hexis/repo"
else
  echo "Error: Cannot find Hexis templates."
  echo ""
  echo "Either:"
  echo "  1. Run hexis from the cloned repo directory"
  echo "  2. Clone to ~/.hexis/repo:"
  echo "     git clone https://github.com/hexis-framework/hexis.git ~/.hexis/repo"
  exit 1
fi

TEMPLATES="$HEXIS_HOME/templates"
EXAMPLES="$HEXIS_HOME/examples"

# --- Colors (if terminal supports them) ---

if [ -t 1 ]; then
  BOLD="\033[1m"
  DIM="\033[2m"
  GREEN="\033[32m"
  YELLOW="\033[33m"
  RED="\033[31m"
  RESET="\033[0m"
else
  BOLD="" DIM="" GREEN="" YELLOW="" RED="" RESET=""
fi

# --- Helpers ---

info()  { printf "${GREEN}✓${RESET} %s\n" "$1"; }
warn()  { printf "${YELLOW}!${RESET} %s\n" "$1"; }
error() { printf "${RED}✗${RESET} %s\n" "$1" >&2; }
dim()   { printf "${DIM}  %s${RESET}\n" "$1"; }

copy_if_missing() {
  local src="$1" dest="$2"
  if [ -f "$dest" ]; then
    warn "Already exists: $dest (skipped)"
  else
    mkdir -p "$(dirname "$dest")"
    cp "$src" "$dest"
    info "Created: $dest"
  fi
}

# --- Commands ---

cmd_init() {
  echo ""
  printf "${BOLD}Initializing Hexis in $(pwd)${RESET}\n"
  echo ""

  # Create directory structure
  mkdir -p .claude/hooks
  mkdir -p .claude/skills
  mkdir -p docs/solutions
  dim "Created .claude/hooks/, .claude/skills/, docs/solutions/"

  # Copy core templates
  copy_if_missing "$TEMPLATES/CLAUDE.md" "CLAUDE.md"
  copy_if_missing "$TEMPLATES/MEMORY.md" "MEMORY.md"
  copy_if_missing "$TEMPLATES/rule-violation-log.md" "rule-violation-log.md"

  # Copy safety hook
  copy_if_missing "$TEMPLATES/hooks/bash-guard.js" ".claude/hooks/bash-guard.js"

  echo ""
  printf "${BOLD}Next steps:${RESET}\n"
  echo "  1. Edit CLAUDE.md — add your rules and conventions"
  echo "  2. Register the bash-guard hook in .claude/settings.json:"
  echo ""
  echo '     {'
  echo '       "hooks": {'
  echo '         "PreToolUse": [{'
  echo '           "matcher": "Bash",'
  echo '           "hooks": [{ "type": "command", "command": "node .claude/hooks/bash-guard.js" }]'
  echo '         }]'
  echo '       }'
  echo '     }'
  echo ""
  echo "  3. Run 'hexis list' to see available modules"
  echo "  4. Run 'hexis add <module>' to add skills and hooks"
  echo ""
  echo "  See: https://github.com/hexis-framework/hexis/blob/main/docs/getting-started.md"
  echo ""
}

cmd_add() {
  local module="${1:-}"

  if [ -z "$module" ]; then
    error "Usage: hexis add <module>"
    echo ""
    echo "Run 'hexis list' to see available modules."
    exit 1
  fi

  # Check skills
  if [ -d "$EXAMPLES/skills/$module" ]; then
    local dest=".claude/skills/$module"
    if [ -d "$dest" ]; then
      warn "Already exists: $dest"
      echo "  Remove it first if you want to replace it."
      exit 1
    fi
    mkdir -p "$dest"
    cp -r "$EXAMPLES/skills/$module/"* "$dest/"
    info "Added skill: $module → $dest/"
    echo ""
    dim "Restart Claude Code to activate the skill."
    dim "Invoke with: /$module"
    return
  fi

  # Check hooks
  if [ -f "$TEMPLATES/hooks/$module.js" ]; then
    copy_if_missing "$TEMPLATES/hooks/$module.js" ".claude/hooks/$module.js"
    echo ""
    warn "Remember to register the hook in .claude/settings.json"
    dim "See: https://github.com/hexis-framework/hexis/blob/main/docs/hook-patterns.md"
    return
  fi

  # Check templates
  if [ -f "$TEMPLATES/$module.md" ] || [ -f "$TEMPLATES/$module" ]; then
    local src=""
    if [ -f "$TEMPLATES/$module.md" ]; then
      src="$TEMPLATES/$module.md"
      copy_if_missing "$src" "$module.md"
    else
      src="$TEMPLATES/$module"
      copy_if_missing "$src" "$module"
    fi
    return
  fi

  error "Unknown module: $module"
  echo ""
  echo "Run 'hexis list' to see available modules."
  exit 1
}

cmd_list() {
  echo ""
  printf "${BOLD}Available modules${RESET}\n"
  echo ""

  # Skills
  if [ -d "$EXAMPLES/skills" ]; then
    printf "${BOLD}Skills:${RESET}\n"
    for skill_dir in "$EXAMPLES/skills"/*/; do
      if [ -f "$skill_dir/SKILL.md" ]; then
        local name
        name=$(basename "$skill_dir")
        # Extract description from frontmatter
        local desc
        desc=$(grep "^description:" "$skill_dir/SKILL.md" 2>/dev/null | head -1 | sed 's/^description: *//')
        printf "  %-20s %s\n" "$name" "$desc"
      fi
    done
    echo ""
  fi

  # Hooks
  printf "${BOLD}Hooks:${RESET}\n"
  for hook in "$TEMPLATES/hooks"/*.js; do
    if [ -f "$hook" ]; then
      local name
      name=$(basename "$hook" .js)
      # Extract description from first JSDoc line
      local desc
      desc=$(grep "^ \* Hexis" "$hook" 2>/dev/null | head -1 | sed 's/^ \* Hexis //' | sed 's/ —.*//')
      printf "  %-20s %s\n" "$name" "${desc:-Hook}"
    fi
  done
  echo ""

  # Templates
  printf "${BOLD}Templates:${RESET}\n"
  printf "  %-20s %s\n" "CLAUDE" "Annotated CLAUDE.md with rule maturity"
  printf "  %-20s %s\n" "MEMORY" "MEMORY.md with routing guidance"
  printf "  %-20s %s\n" "SKILL" "Skill template file"
  printf "  %-20s %s\n" "rule-violation-log" "Enforcement escalation tracker"
  echo ""

  dim "Usage: hexis add <module-name>"
  echo ""
}

# --- Sync ---

SYNC_HOSTS_FILE="${HEXIS_HOME}/.sync-hosts"
SYNC_PLIST_LABEL="com.terryli.cc-sync"
SYNC_INTERVAL=14400  # 4 hours

# Repos to keep in sync
SYNC_REPOS=(
  "terry-li-hm/agent-config"
  "terry-li-hm/skills"
)

sync_setup_host() {
  local host="$1"

  printf "${BOLD}Setting up sync on ${host}${RESET}\n"
  echo ""

  # Test SSH
  if ! ssh -o ConnectTimeout=5 "$host" "echo ok" >/dev/null 2>&1; then
    error "Cannot SSH to $host"
    exit 1
  fi
  info "SSH connection OK"

  # Check prerequisites
  ssh "$host" 'export PATH=/opt/homebrew/bin:/usr/local/bin:$PATH; which git >/dev/null 2>&1' || {
    error "git not found on $host"
    exit 1
  }
  ssh "$host" 'export PATH=/opt/homebrew/bin:/usr/local/bin:$PATH; gh auth status >/dev/null 2>&1' || {
    error "gh not authenticated on $host — run: ssh $host \"gh auth login -h github.com -p https -w\""
    exit 1
  }
  info "Prerequisites OK (git, gh auth)"

  # Clone repos
  for repo in "${SYNC_REPOS[@]}"; do
    local name="${repo#*/}"
    ssh "$host" "test -d ~/$name/.git" 2>/dev/null && {
      warn "$name already cloned"
    } || {
      ssh "$host" "export PATH=/opt/homebrew/bin:/usr/local/bin:\$PATH; cd ~ && gh repo clone $repo 2>&1"
      info "Cloned $name"
    }
  done

  # Set up symlinks
  ssh "$host" bash -s <<'REMOTE'
set -e
# ~/bin → agent-config/bin
if [ -L ~/bin ] && [ "$(readlink ~/bin)" = "$HOME/agent-config/bin" ]; then
  : # already correct
elif [ -d ~/bin ] && [ ! -L ~/bin ]; then
  mv ~/bin ~/bin.bak
  ln -sf ~/agent-config/bin ~/bin
else
  ln -sf ~/agent-config/bin ~/bin
fi

# .claude directory structure
mkdir -p ~/.claude/projects/-Users-terry/memory

# Skills symlink
ln -sf ~/skills ~/.claude/skills 2>/dev/null || true

# Hooks symlink
if [ -d ~/agent-config/claude/hooks ]; then
  rm -rf ~/.claude/hooks 2>/dev/null || true
  ln -sf ~/agent-config/claude/hooks ~/.claude/hooks
fi

# Memory symlink
if [ -f ~/agent-config/claude/memory/MEMORY.md ]; then
  ln -sf ~/agent-config/claude/memory/MEMORY.md ~/.claude/projects/-Users-terry/memory/MEMORY.md 2>/dev/null || true
fi

# Settings (copy, not symlink — may need local tweaks)
if [ -f ~/agent-config/claude/settings.json ]; then
  cp ~/agent-config/claude/settings.json ~/.claude/settings.json
fi
REMOTE
  info "Symlinks and .claude directory configured"

  # Install LaunchAgent (macOS) or cron (Linux)
  local os
  os=$(ssh "$host" "uname -s")
  if [ "$os" = "Darwin" ]; then
    ssh "$host" "cat > ~/Library/LaunchAgents/${SYNC_PLIST_LABEL}.plist" <<PLIST
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>${SYNC_PLIST_LABEL}</string>
    <key>ProgramArguments</key>
    <array>
        <string>/bin/bash</string>
        <string>-c</string>
        <string>export PATH=/opt/homebrew/bin:/usr/local/bin:/usr/bin:/bin; git -C \$HOME/agent-config pull --ff-only 2>&1; git -C \$HOME/skills pull --ff-only 2>&1</string>
    </array>
    <key>StartInterval</key>
    <integer>${SYNC_INTERVAL}</integer>
    <key>StandardOutPath</key>
    <string>/tmp/cc-sync.log</string>
    <key>StandardErrorPath</key>
    <string>/tmp/cc-sync.log</string>
    <key>RunAtLoad</key>
    <true/>
</dict>
</plist>
PLIST
    ssh "$host" "launchctl unload ~/Library/LaunchAgents/${SYNC_PLIST_LABEL}.plist 2>/dev/null; launchctl load ~/Library/LaunchAgents/${SYNC_PLIST_LABEL}.plist"
    info "LaunchAgent installed (every $(( SYNC_INTERVAL / 3600 ))h + on login)"
  else
    # Linux: use cron
    local cron_cmd="*/$(( SYNC_INTERVAL / 60 )) * * * * cd \$HOME && git -C agent-config pull --ff-only && git -C skills pull --ff-only >> /tmp/cc-sync.log 2>&1"
    ssh "$host" "(crontab -l 2>/dev/null | grep -v cc-sync; echo '# cc-sync'; echo '$cron_cmd') | crontab -"
    info "Cron job installed (every $(( SYNC_INTERVAL / 60 ))m)"
  fi

  # Register host
  touch "$SYNC_HOSTS_FILE"
  if ! grep -q "^${host}$" "$SYNC_HOSTS_FILE" 2>/dev/null; then
    echo "$host" >> "$SYNC_HOSTS_FILE"
  fi

  echo ""
  info "Sync configured for $host"
  dim "Trigger manual sync: hexis sync now $host"
  dim "Check status:        hexis sync status"
}

sync_status() {
  if [ ! -f "$SYNC_HOSTS_FILE" ] || [ ! -s "$SYNC_HOSTS_FILE" ]; then
    warn "No sync hosts configured. Run: hexis sync setup <host>"
    return
  fi

  printf "${BOLD}Sync status${RESET}\n"
  echo ""

  while IFS= read -r host; do
    [ -z "$host" ] && continue
    printf "  ${BOLD}%s${RESET} — " "$host"
    if ssh -o ConnectTimeout=3 "$host" "cat /tmp/cc-sync.log 2>/dev/null | tail -1" 2>/dev/null; then
      :
    else
      printf "${RED}unreachable${RESET}\n"
    fi
  done < "$SYNC_HOSTS_FILE"
  echo ""
}

sync_now() {
  local host="${1:-}"
  if [ -z "$host" ]; then
    # Sync all known hosts
    if [ ! -f "$SYNC_HOSTS_FILE" ]; then
      error "No sync hosts configured"
      exit 1
    fi
    while IFS= read -r h; do
      [ -z "$h" ] && continue
      sync_now "$h"
    done < "$SYNC_HOSTS_FILE"
    return
  fi

  printf "Syncing ${BOLD}%s${RESET}..." "$host"
  if ssh -o ConnectTimeout=5 "$host" "export PATH=/opt/homebrew/bin:/usr/local/bin:/usr/bin:/bin:\$PATH; git -C ~/agent-config pull --ff-only 2>&1; git -C ~/skills pull --ff-only 2>&1" >/dev/null 2>&1; then
    printf " ${GREEN}done${RESET}\n"
  else
    printf " ${RED}failed${RESET}\n"
  fi
}

cmd_sync() {
  local subcmd="${1:-status}"
  shift 2>/dev/null || true

  case "$subcmd" in
    setup)
      if [ -z "${1:-}" ]; then
        error "Usage: hexis sync setup <ssh-host>"
        echo "  Example: hexis sync setup m3"
        exit 1
      fi
      sync_setup_host "$1"
      ;;
    status) sync_status ;;
    now)    sync_now "${1:-}" ;;
    *)
      error "Unknown sync command: $subcmd"
      echo "  hexis sync setup <host>   Set up sync on a remote machine"
      echo "  hexis sync status         Check sync status across hosts"
      echo "  hexis sync now [host]     Trigger immediate sync"
      exit 1
      ;;
  esac
}

cmd_help() {
  echo ""
  printf "${BOLD}hexis${RESET} — scaffolder for the Hexis meta-cognitive framework\n"
  echo ""
  printf "${BOLD}Usage:${RESET}\n"
  echo "  hexis init              Create Hexis directory structure in current project"
  echo "  hexis add <module>      Add a module (skill, hook, or template)"
  echo "  hexis sync <cmd>        Sync CC environment across machines"
  echo "  hexis list              List available modules"
  echo "  hexis help              Show this help"
  echo ""
  printf "${BOLD}Examples:${RESET}\n"
  echo "  hexis init              # Set up Hexis in a new project"
  echo "  hexis add wrap          # Add the session wrap-up skill"
  echo "  hexis add stuck-detector # Add the stuck detector hook"
  echo "  hexis sync setup m3    # Set up sync on a remote Mac/Linux"
  echo "  hexis sync now          # Pull repos on all synced machines"
  echo ""
  printf "${BOLD}Learn more:${RESET}\n"
  echo "  https://github.com/hexis-framework/hexis"
  echo ""
}

# --- Main ---

command="${1:-help}"
shift 2>/dev/null || true

case "$command" in
  init)  cmd_init ;;
  add)   cmd_add "$@" ;;
  sync)  cmd_sync "$@" ;;
  list)  cmd_list ;;
  help)  cmd_help ;;
  -h|--help) cmd_help ;;
  *)
    error "Unknown command: $command"
    cmd_help
    exit 1
    ;;
esac
